<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>–ï—Ñ–µ–º–µ—Ä–∏–¥–∏</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background: #fff;
      color: #2c3e50;
    }
    .header {
      display: flex;
      align-items: center;
      border-bottom: 2px solid #ddd;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header img {
      height: 70px;
      margin-right: 20px;
    }
    .header-text h1 {
      font-size: 20px;
      margin: 0 0 6px;
      font-weight: 600;
    }
    .header-text p {
      margin: 0;
      font-size: 14px;
      color: #555;
    }
    #report-title {
      font-size: 22px;
      margin: 0 0 25px;
    }
    h3 {
      margin: 30px 0 10px;
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background: #34495E;
      color: #ECF0F1;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #F7F9FA;
    }
    .footer {
      margin-top: 50px;
      font-size: 12px;
      text-align: center;
      color: #888;
    }
  </style>
</head>
<body>

  <div class="header">
    <img src="https://i.postimg.cc/DZh0SV41/image.png" alt="–õ–æ–≥–æ—Ç–∏–ø">
    <div class="header-text">
      <h1>–ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç –ø—Ä–∏–∫–ª–∞–¥–Ω–æ—ó –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó, –ø–∞—Ä–∞–ø—Å–∏—Ö–æ–ª–æ–≥—ñ—ó —Ç–∞ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å –∞–Ω–æ–º–∞–ª—å–Ω–∏—Ö —è–≤–∏—â –ï-–¢–ï–†–†–ê</h1>
      <p><a href="https://e-terra.com.ua" target="_blank">https://e-terra.com.ua</a></p>
    </div>
  </div>

  <h2 id="report-title">–ï—Ñ–µ–º–µ—Ä–∏–¥–∏</h2>
  <div id="ephemerides-content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

  <div class="footer">
    –ó–≤—ñ—Ç –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –î–∞–Ω—ñ: –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–æ–¥–µ–ª–µ–π NASA JPL.<br>
    –Ü–Ω—Å—Ç–∏—Ç—É—Ç –ï-–¢–ï–†–†–ê, ¬© 2025
  </div>

  <script>
  (async () => {
    // –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const p = new URLSearchParams(window.location.search);
    const city  = p.get("city")  || "";
    const start = p.get("start") || "";
    const end   = p.get("end")   || "";
    const time  = p.get("time")  || "";
    const titleEl = document.getElementById("report-title");
    const content = document.getElementById("ephemerides-content");

    // –ü—Ä–æ–≤–µ—Ä–∫–∞
    if (!city || !start || !end || !time) {
      titleEl.innerText = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏";
      content.innerHTML = '<p style="color:red;">‚ùó –ü–µ—Ä–µ–¥–∞–π—Ç–µ –≤ URL: city, start, end, time</p>';
      return;
    }

    titleEl.innerText = `–ï—Ñ–µ–º–µ—Ä–∏–¥–∏ –¥–ª—è ${city} –∑ ${start} –ø–æ ${end} (${time})`;
    content.innerHTML = "";

    // –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
    const PLANET_NAMES = {
      Sun:'–°–æ–Ω—Ü–µ', Moon:'–ú—ñ—Å—è—Ü—å', Mercury:'–ú–µ—Ä–∫—É—Ä—ñ–π', Venus:'–í–µ–Ω–µ—Ä–∞',
      Mars:'–ú–∞—Ä—Å', Jupiter:'–Æ–ø—ñ—Ç–µ—Ä', Saturn:'–°–∞—Ç—É—Ä–Ω', Uranus:'–£—Ä–∞–Ω',
      Neptune:'–ù–µ–ø—Ç—É–Ω', Pluto:'–ü–ª—É—Ç–æ–Ω'
    };
    const ASPECT_NAMES = {
      conjunction:'–∑‚Äô—î–¥–Ω–∞–Ω–Ω—è', opposition:'–æ–ø–æ–∑–∏—Ü—ñ—è',
      trine:'—Ç—Ä–∏–Ω', square:'–∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞', sextile:'—Å–µ–∫—Å—Ç–∏–ª—å'
    };
    const SIGNS = ['–û–≤–µ–Ω','–¢–µ–ª–µ—Ü—å','–ë–ª–∏–∑–Ω—é–∫–∏','–†–∞–∫','–õ–µ–≤','–î—ñ–≤–∞','–¢–µ—Ä–µ–∑–∏','–°–∫–æ—Ä–ø—ñ–æ–Ω','–°—Ç—Ä—ñ–ª–µ—Ü—å','–ö–æ–∑–æ—Ä—ñ–≥','–í–æ–¥–æ–ª—ñ–π','–†–∏–±–∏'];

    // 1) –ì–µ–æ–∫–æ–¥–∏–Ω–≥
    let places = [];
    try {
      places = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(city)}`
      ).then(r=>r.json());
    } catch(e){}
    if (!places.length) {
      content.innerHTML = `<p style="color:red;">–ú—ñ—Å—Ç–æ "${city}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>`;
      return;
    }
    const { lat, lon } = places[0];

    // 2) –ó–∞ –∫–∞–∂–¥—ã–º –¥–Ω—ë–º
    const ds = new Date(start);
    const de = new Date(end);
    for (let d = new Date(ds); d <= de; d.setDate(d.getDate()+1)) {
      const date = d.toISOString().split('T')[0];

      // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ª–æ–∫. -> UTC time
      const loc = new Date(`${date}T${time}`);
      const utc = new Date(loc.getTime() + loc.getTimezoneOffset()*60000);
      const tp = [utc.getUTCHours(),utc.getUTCMinutes(),utc.getUTCSeconds()]
        .map(n=>String(n).padStart(2,'0')).join(':');

      // –ó–∞–ø—Ä–æ—Å —ç—Ñ–µ–º–µ—Ä–∏–¥
      const [Y,M,D] = date.split('-');
      const apiUrl = `https://ephemerides-api.onrender.com/ephemerides`
        + `?year=${Y}&month=${M}&day=${D}&time=${tp}&lat=${lat}&lon=${lon}`;
      let data;
      try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw await res.text();
        data = await res.json();
      } catch(err) {
        content.innerHTML += `<h3>${date}</h3><p style="color:red;">${err}</p>`;
        continue;
      }

      // –†–µ–Ω–¥–µ—Ä–∏–º –¥–µ–Ω—å
      let html = `<h3>${date}</h3>`;
      const st = data.sidereal_time;
      const H  = Math.floor(st);
      const m  = Math.floor((st - H) * 60);
      const s  = Math.round((st - H) * 3600 - m * 60);
      html += `<p><strong>–°–∏–¥–µ—Ä–∏—á–Ω–∏–π —á–∞—Å:</strong> ${H}—á ${m}–º ${s}—Å; `
           + `<strong>ASC:</strong> ${data.asc?.toFixed(2) || '-'}¬∞; `
           + `<strong>MC:</strong> ${data.mc?.toFixed(2) || '-'}¬∞</p>`;

      // –ü–ª–∞–Ω–µ—Ç—ã
      html += `<table><thead><tr><th>–ü–ª–∞–Ω–µ—Ç–∞</th><th>–î–æ–≤–≥–æ—Ç–∞,¬∞</th><th>–ó–Ω–∞–∫</th></tr></thead><tbody>`;
      for (const [pl, lonVal] of Object.entries(data.positions)) {
        const nameUa = PLANET_NAMES[pl] || pl;
        const idx = Math.floor((lonVal % 360) / 30);
        const deg = (lonVal % 30).toFixed(2);
        html += `<tr><td>${nameUa}</td><td>${lonVal.toFixed(2)}</td><td>${SIGNS[idx]} ${deg}¬∞</td></tr>`;
      }
      html += `</tbody></table>`;

      // –ê—Å–ø–µ–∫—Ç—ã
      html += `<table><thead><tr><th>–ê—Å–ø–µ–∫—Ç</th><th>–ú—ñ–∂</th><th>–ö—É—Ç,¬∞</th></tr></thead><tbody>`;
      for (const a of data.aspects) {
        const aspectUa = ASPECT_NAMES[a.aspect] || a.aspect;
        const betweenUa = a.between.map(pl=>PLANET_NAMES[pl]||pl).join('¬†‚Äì¬†');
        html += `<tr><td>${aspectUa}</td><td>${betweenUa}</td><td>${a.angle.toFixed(2)}</td></tr>`;
      }
      html += `</tbody></table>`;

      content.innerHTML += html;
    }
  })();
  </script>
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- –ö–Ω–æ–ø–∫–∞ -->
<div style="text-align:center; margin-top:20px;">
  <button onclick="downloadPDF()" style="padding:10px 20px; font-size:16px; background:#2c3e50; color:#fff; border:none; border-radius:6px; cursor:pointer;">
    üì• –°–∫–∞—á–∞—Ç—å PDF
  </button>
</div>

<script>
function downloadPDF() {
  const element = document.body.cloneNode(true);
  element.querySelector('button')?.remove(); // —É–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –∏–∑ PDF
  html2pdf().from(element).set({
    margin: 1,
    filename: 'efemeridy.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
  }).save();
}
</script>

</body>
</html>
